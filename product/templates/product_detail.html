{% extends 'base.html' %}

{% block content %}

<body style="margin-top:120px;">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <img src="{{ product.image.url }}" alt="Product Image" class="img-fluid">
            </div>
            <div class="col-md-6">
                <h2>{{ product.product_name }}</h2>
                <p>{{ product.description }}</p>
                <p>Price: $ {{ product.price }}</p>
                <p style="font-size:20px;" class="fs-1">Size: {{product.sizes}}</p>

                <!-- Product Rating -->
                <h5>Average Rating: {{ average_rating }} </h5>
                <h5>Color: {{ product.color }} </h5>


                <!-- Add to Cart Button -->


                <!-- Buy Now Button -->

            </div>
        </div>

        <!-- Reviews Section -->
        <div class="row mt-4">
            <div class="col-md-12">
                {% if request.user.is_authenticated %}
                <div>
                    <h4>Add Your Review</h4>
                    <form id="rating-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <div class="form-group rating-box">
                            <h3>Rate this product</h3>
                            <div class="stars">
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Rating</button>
                    </form>
                </div>
                <form id="comment-form">
                    <input type="hidden" name="user" value="{{ request.user.id }}">
                    <input type="hidden" name="product" value="{{ product.id }}">
                    <textarea name="comment" cols="30" rows="5"></textarea>
                    <button type="submit">Submit Comment</button>
                </form>
                
                {% else %}

                <p style="font-size:20px " class="text-center mt-1">Login first to add rviews and ratings <a
                        href="{% url 'login'%}">Login</a></p>

                {% endif %}

                <h3>Customer Reviews</h3>
                <!-- Display existing reviews here -->
                {% for comment in comments %}
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">{{ comment.user.username }}</h5>
                        <p class="card-text">{{ comment.comment }}</p>
                    </div>
                </div>
                {% empty %}
                <p>No reviews yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Add Bootstrap JS and jQuery scripts here -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ratingForm = document.getElementById('rating-form');
            let selectedStars = 0 ;


            const stars = document.querySelectorAll(".stars i");
            // Loop through the "stars" NodeList
            stars.forEach((star, index1) => {
                // Add an event listener that runs a function when the "click" event is triggered
                star.addEventListener("click", () => {

                    selectedStars = index1 + 1 ;
                    console.log(selectedStars, "selectedStars");
                    // Loop through the "stars" NodeList Again
                    stars.forEach((star, index2) => {
                        // Add the "active" class to the clicked star and any stars with a lower index
                        // and remove the "active" class from any stars with a higher index
                        index1 >= index2 ? star.classList.add("active") : star.classList.remove("active");
                    });
                });
            });


            ratingForm.addEventListener('submit', function (event) {
                event.preventDefault();

                //console.log(selectedStars)

                const user = "{{ request.user.id }}";
                const product = "{{ product.id }}";
                //const selectedStars = selectedStars;


                // Make an AJAX request to submit the rating
                fetch('http://127.0.0.1:8000/product/api/ratting/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        user: user,
                        product: product,
                        rating: selectedStars,
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Rating submitted successfully:', data);
                        location.reload(); // Reload the page
                    })
                    .catch(error => {
                        console.error('Error submitting rating:', error);
                    });
                
            });

            // Function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
        //Get Comment and Submit---------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            const commentForm = document.getElementById('comment-form');
        
            commentForm.addEventListener('submit', function(event) {
                event.preventDefault();
        
                const user = this.querySelector('[name="user"]').value;
                const product = this.querySelector('[name="product"]').value;
                const comment = this.querySelector('[name="comment"]').value;
        
                fetch('http://127.0.0.1:8000/product/api/comment/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        user: user,
                        product: product,
                        comment: comment
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Comment submitted successfully:', data);
                    location.reload(); // Reload the page
                })
                .catch(error => {
                    console.error('Error submitting comment:', error);
                });
            });
        
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
        
    </script>
</body>

{% endblock %}